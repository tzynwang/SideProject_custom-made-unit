{% extends "layout.html" %}

{% block title %}
    設定
{% endblock %}

{% block main %}

    <div class="" role="alert" id="hintBox">
        <span id="hintText"></span>
    </div>

    <table class="table table-bordered">
        <tbody>
            <tr>
                <td><label for="targetAmountSpan">金額</label></td>
                <td><span id="targetAmountSpan">{{ targetAmount }}</span><span>元</span></td>
                <td>
                    <input class="form-control" name="targetGroup" id="targetAmount" type="number" 
                    placeholder="最少為1元" min="1">
                </td>
                <td>
                    <button class="btn btn-primary" type="button" onclick="updateTargets('targetAmount')">更新</button>
                </td>
            </tr>
            <tr>
                <td><label for="targetSpan">代表金額的目標</label></td>
                <td><span id="targetSpan">{{ target }}</span></td>
                <td>
                    <input class="form-control" name="targetGroup" id="target" type="text" 
                    placeholder="例子：iPad" maxlength="24">
                </td>
                <td>
                    <button class="btn btn-primary" type="button" onclick="updateTargets('target')">更新</button>
                </td>
            </tr>
            <tr>
                <td><label for="targetUnitSpan">目標的單位</label></td>
                <td><span id="targetUnitSpan">{{ targetUnit }}</span></td>
                <td>
                    <input class="form-control" name="targetGroup" id="targetUnit" type="text" 
                    placeholder="例子：臺" maxlength="8">
                </td>
                <td>
                    <button class="btn btn-primary" type="button" onclick="updateTargets('targetUnit')">更新</button>
                </td>
            </tr>

            <tr>
                <td><label for="gNames">更新帳目分組名稱</label></td>
                <td>
                    <select class="form-control" id="gNames">
                        <option selected disabled value="">先選擇組別</option>
                        <option id="op0" value="g0">{{ groupName[0] }}</option>
                        <option id="op1" value="g1">{{ groupName[1] }}</option>
                        <option id="op2" value="g2">{{ groupName[2] }}</option>
                        <option id="op3" value="g3">{{ groupName[3] }}</option>
                    </select>
                </td>
                <td><input class="form-control" id="updateName" type="text" placeholder="再輸入自訂名稱" maxlength="24"></td>
                <td><button class="btn btn-primary" type="button" onclick="updateName()">更新</button></td>
            </tr>

            <tr>
                <td>
                    <lable for="pass1">更新密碼</lable><br>
                </td>
                <td>
                    <input class="form-control" type="password" autocomplete="off" name="password" id="pass1" 
                    placeholder="密碼 (長度限制8-24字)">
                </td>
                <td>
                    <input class="form-control" type="password" autocomplete="off" name="confirmation" id="pass2" 
                    placeholder="確認 (數字英文各1)">
                </td>
                <td><button class="btn btn-primary" type="button" onclick="updatePass()">更新</button></td>
            </tr>
        </tbody>
    </table>

    <script>        
        $(document).ready(
            $("#hintBox").hide()
        );

        function updateTargets(updateID) {
            var t = $("#"+updateID).val();
            if (!t) {
                $("#hintBox").attr("class");
                $("#hintBox").attr("class", "alert alert-warning").show();
                $("#hintText").html("請輸入內容");
            }
            else if (updateID == 'targetAmount' && t < 1) {
                $("#hintBox").attr("class");
                $("#hintBox").attr("class", "alert alert-warning").show();
                $("#hintText").html("目標金額至少為1");
            }
            else {
                $("#hintBox").hide();
                $.ajax({
                    url: "/updateTarget",
                    type: "POST",
                    data: JSON.stringify({"tType": updateID, "content": t}),
                    dataType: "json",
                    contentType : "application/json; charset=UTF-8'",
                    success: function (result) {
                        $("#hintBox").attr("class");
                        $("#hintText").html("更新成功");
                        $("#hintBox").attr("class", "alert alert-success").show().delay(3000).fadeOut();
                        
                        $("#"+updateID).val("");
                        $("#"+updateID+"Span").html(result);
                    }
                });
            }
        }

        function updateName() {
            var updateName = $("#updateName").val();
            var selectGroup = $("#gNames").val();

            if (!updateName || !selectGroup) {
                $("#hintBox").attr("class");
                $("#hintBox").attr("class", "alert alert-warning").show();
                $("#hintText").html("請選擇組別並輸入欲更新之名稱");
            }
            else {
                $("#hintBox").hide();
                $.ajax({
                    url: "/updateGroupName",
                    type: "POST",
                    data: JSON.stringify({"gNames": selectGroup, "updateName": updateName}),
                    dataType: "json",
                    contentType : "application/json; charset=UTF-8'",
                    success: function(result) {
                        if (result == false) {
                            $("#hintText").html("分組名稱更新失敗");
                            $("#hintBox").attr("class");
                            $("#hintBox").attr("class", "alert alert-danger").show().delay(3000).fadeOut();
                        }
                        else {                           
                            $("#hintText").html("分組名稱更新成功");
                            $("#hintBox").attr("class");
                            $("#hintBox").attr("class", "alert alert-success").show().delay(3000).fadeOut();
                            
                            for (i = 0; i < 4; i ++) {
                                $("#op"+i).text(result[i]);
                            }
                            
                            $("#updateName").val("");
                        }  
                    },
                });
            }
        }

        function updatePass() {
            var pass1 = $('#pass1').val();
            var pass2 = $('#pass2').val();
            if (!pass1 || !pass2) {
                $("#hintBox").attr("class");
                $("#hintBox").attr("class", "alert alert-success").show();
                $("#hintText").html("請輸入密碼與確認密碼");
            }
            else if (pass1 != pass2) { 
                $("#hintBox").attr("class");
                $("#hintBox").attr("class", "alert alert-success").show();
                $("#hintText").html("密碼與確認密碼的內容不同");
            }
            else if (pass1 == pass2) {
                $("#hintBox").hide();
                $.ajax({
                    url: "/checkPass",
                    type: "POST",
                    data: JSON.stringify({"pass1": pass1}),
                    dataType: "json",
                    contentType : "application/json",
                    success: function(result) {
                        if (result == "nameContFail") {
                            $("#hintBox").attr("class");
                            $("#hintBox").attr("class", "alert alert-success").show();
                            $("#hintText").html("密碼內容不符合規範");
                        }
                        if (result == "lenFail") {
                            $("#hintBox").attr("class");
                            $("#hintBox").attr("class", "alert alert-success").show();
                            $("#hintText").html("密碼長度不符合規範");
                        }
                        if (result == true) {
                            $("#hintBox").hide();
                            $.ajax({
                                url: "/updatePass",
                                type: "POST",
                                data: JSON.stringify({"pass1": pass1}),
                                dataType: "json",
                                contentType : "application/json",
                                success: function() {
                                    $('#pass1').val("");
                                    $('#pass2').val("");
                                    
                                    $("#hintText").html("密碼更新成功");
                                    $("#hintBox").attr("class");
                                    $("#hintBox").attr("class", "alert alert-success").show().delay(3000).fadeOut();
                                },
                                error: function() {
                                    $("#hintText").html("密碼更新失敗");
                                    $("#hintBox").attr("class");
                                    $("#hintBox").attr("class", "alert alert-danger").show().delay(3000).fadeOut();
                                }
                            });
                        }
                    },
                });
            }
        }

    </script>
{% endblock %}