{% extends "layout.html" %}

{% block title %}
    狀態
{% endblock %}

{% block nav %}
    {% include "nav.html" %}
{% endblock %}

{% block main %}
    {% if not session.verified %}
        <p>帳號"{{ username }}"還沒被啟動，請至{{ email }}收信，點擊信中提供的網址來啟動帳號</p>
        <span id="AuthMail" class="p-mimic">沒有收到認證信？請<a href="/gen_token" id="sendAuthMail">點此</a>來重新發送帳號認證信件</span>
    {% else %}
        {% if not session.targetamount %}
            <p>還沒設定目標金額？<a href="/setting#targetAmount">點此</a>來進行設定</p>
            <br>
        {% else %}
            <span class="p-mimic">
                <input class="form-control" type="month" id="calender">
                <span id="current">(本月)</span>的累積消費金額為：<span id="monthBill">{{ amount }}</span>元
            </span>
            <span id="targets" class="p-mimic">，大約是<span id="percentage">{{ percentage }}</span>
                {% for item in targets -%}
                    <span class="p-mimic">{{ item }}</span>
                {%- endfor %}
            </span>
        {% endif %}
    {% endif %}

    <script>
        $("#sendAuthMail").on("click", function() {
            $("#AuthMail").text("重新確認中……");
        });

        var thisMonth = null;
        $(function() { // set calender time
            var t = new Date();
            var YYYY = t.getFullYear();
            var MM = t.getMonth()+1; // getMonth() is zero-based
            thisMonth = YYYY+"-"+MM;

            $("#calender").attr({
                value: thisMonth,
                min: (YYYY-1)+"-"+MM,
                max: thisMonth
            });
        });

        $("#calender").on("change", function() {
            var date = $("#calender").val();
            
            if (date == thisMonth) {
                $("#current").text("(本月)");
            }
            else {
                $("#current").text("");
            }

            if (date == "") {
                $("#monthBill, #percentage").text("0");
                $("#targets").hide();
            }
            else {
                $.ajax({
                    url: "/queryMonthSum",
                    type: "POST",
                    data: JSON.stringify({"date": date}),
                    dataType: "json",
                    contentType: "application/json",
                    success: function(result) {
                        if (result["amount"] == 0) {
                            //no bill(s) in this month
                            $("#monthBill, #percentage").text("0");
                            $("#targets").hide();
                        }
                        else {
                            $("#targets").show();
                            $("#monthBill").text(result["amount"]);
                            $("#percentage").text(result["percentage"].toFixed(2));
                        }
                    }
                });
            }
        });
    </script>
{% endblock %}